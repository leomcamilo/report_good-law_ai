# An√°lise e Minera√ß√£o de Dados de Projetos da Lei do Bem

Este projeto implementa um pipeline completo de an√°lise de dados para projetos submetidos ao sistema da Lei do Bem do MCTI. Utiliza t√©cnicas avan√ßadas de ci√™ncia de dados, machine learning e an√°lise estat√≠stica para identificar padr√µes de decis√£o, inconsist√™ncias no processo e oportunidades de otimiza√ß√£o do fluxo de an√°lise.

## üìã Pr√©-requisitos

- Python 3.9+
- PostgreSQL rodando localmente na porta 5432
- Banco de dados `dbs_mctic2` configurado
- Credenciais: usu√°rio `ia_budy`, senha `ia_budy`
- [uv](https://docs.astral.sh/uv/) - Gerenciador de pacotes Python moderno

## üöÄ Instala√ß√£o

### 1. **Instalar uv (se ainda n√£o tiver):**

```bash
# macOS / Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### 2. **Configurar o projeto:**

```bash
# Clonar/navegar para o diret√≥rio do projeto
cd /home/leomcamilo/projects/test_pgai

# Instalar depend√™ncias e criar ambiente virtual
# Isso instalar√° pandas, sqlalchemy, scikit-learn, sentence-transformers, shap, etc.
uv sync

# Ativar ambiente virtual
source .venv/bin/activate  # Linux/macOS
# ou
.venv\Scripts\activate     # Windows
```

## üèóÔ∏è Estrutura do Projeto

```
test_pgai/
‚îú‚îÄ‚îÄ pyproject.toml                       # Configura√ß√£o e depend√™ncias
‚îú‚îÄ‚îÄ .venv/                               # Ambiente virtual (criado pelo uv)
‚îú‚îÄ‚îÄ 1.csv_gerador_projetos.py            # Etapa 1: Extra√ß√£o de dados do PostgreSQL
‚îú‚îÄ‚îÄ 2.report_e_clustering_k_mean.py    # Etapa 2: Clusteriza√ß√£o e an√°lise de padr√µes
‚îú‚îÄ‚îÄ analise_multivariada_lei_bem.py      # Etapa 3: An√°lise multivariada com ML
‚îú‚îÄ‚îÄ analise_analistas.py                 # Etapa 4: An√°lise espec√≠fica dos analistas t√©cnicos
‚îú‚îÄ‚îÄ prompt.md                            # Templates para an√°lise com LLMs
‚îú‚îÄ‚îÄ tabelas_csv_xlsx/                    # Dados aglomerados extra√≠dos (CSV/Excel)
‚îú‚îÄ‚îÄ csv_longo/                           # Dados detalhados linha √∫nica
‚îú‚îÄ‚îÄ Analises/                            # Relat√≥rios e resultados de an√°lise
‚îú‚îÄ‚îÄ imagens_relatorio/                   # Visualiza√ß√µes geradas
‚îî‚îÄ‚îÄ README.md                            # Este arquivo
```

## üìä Pipeline Completo de An√°lise

O processo √© estruturado em **quatro etapas principais** que analisam o fluxo completo dos projetos da Lei do Bem:

### üîß Etapa 1: Extra√ß√£o e Consolida√ß√£o de Dados

**Arquivo:** [`1.csv_gerador_projetos.py`](1.csv_gerador_projetos.py)

Extrai dados consolidados dos projetos da Lei do Bem diretamente do banco PostgreSQL, cobrindo todo o fluxo do processo: **Preenchimento ‚Üí An√°lise DO ‚Üí Parecer ‚Üí Contesta√ß√£o**.

```bash
# Ativar ambiente (se n√£o estiver ativo)
source .venv/bin/activate

# Executar extra√ß√£o de dados
python 1.csv_gerador_projetos.py
```

**Funcionalidades:**
- Conex√£o otimizada com PostgreSQL
- Query SQL consolidada que une todas as fases do processo
- Extra√ß√£o de dados aglomerados e detalhados
- Informa√ß√µes de empresas, projetos, analistas e resultados de cada fase

**Sa√≠das geradas:**
- `tabelas_csv_xlsx/projetos_lei_do_bem_2023_AGLOMERADOS.csv` - Dados consolidados
- `csv_longo/projetos_lei_do_bem_2023_DETALHADO_LINHA_UNICA.csv` - Dados detalhados

### ü§ñ Etapa 2: Clusteriza√ß√£o e An√°lise de Padr√µes

**Arquivo:** [`2.report_e_clustering_k_mean.py`](2.report_e_clustering_k_mean.py)

Aplica t√©cnicas avan√ßadas de NLP e Machine Learning para identificar padr√µes sem√¢nticos nos projetos e agrupar projetos similares.

```bash
# Executar clusteriza√ß√£o e an√°lise de padr√µes
python 2.report_e_clustering_k_mean.py
```

**Caracter√≠sticas t√©cnicas:**
- **Modelo de Embeddings:** SERAFIM (portugu√™s especializado) - `PORTULAN/serafim-335m-portuguese-pt-sentence-encoder-ir`
- **Pr√©-processamento:** Stop words customizadas para dom√≠nio P&D
- **Clustering:** K-Means otimizado com sele√ß√£o autom√°tica de K
- **PCA:** Visualiza√ß√£o bidimensional dos clusters
- **An√°lise de decis√£o:** Padr√µes de aprova√ß√£o/reprova√ß√£o por cluster

**Sa√≠das geradas:**
- `Analises/lei_bem_projetos_clusters.csv` - Dataset com clusters
- `Analises/relatorio_clusters_lei_bem.pdf` - Relat√≥rio completo em PDF
- Visualiza√ß√µes PNG dos clusters e padr√µes

### üìà Etapa 3: An√°lise Multivariada com Machine Learning

**Arquivo:** [`analise_multivariada_lei_bem.py`](analise_multivariada_lei_bem.py)

Implementa an√°lise estat√≠stica avan√ßada usando Random Forest + SHAP para identificar fatores determinantes de aprova√ß√£o e inconsist√™ncias entre fases.

```bash
# Executar an√°lise multivariada
python analise_multivariada_lei_bem.py
```

**An√°lises realizadas:**
- **Modelagem preditiva:** Random Forest para prever aprova√ß√£o
- **An√°lise SHAP:** Interpretabilidade das decis√µes do modelo
- **An√°lise entre fases:** Consist√™ncia DO ‚Üí Parecer
- **Feature importance:** Fatores mais influentes na aprova√ß√£o
- **Detec√ß√£o de vieses:** Padr√µes por √°rea, porte de empresa, analista

**Sa√≠das geradas:**
- `insights_padroes_decisao_*.txt` - Relat√≥rio detalhado de insights
- `projetos_com_predicoes.csv` - Projetos com probabilidades de aprova√ß√£o
- `feature_importance.csv` - Import√¢ncia das vari√°veis
- Visualiza√ß√µes de an√°lise estat√≠stica

### üéØ Etapa 4: An√°lise Espec√≠fica dos Analistas T√©cnicos

**Arquivo:** [`analise_analistas.py`](analise_analistas.py) *(Em desenvolvimento)*

Foca na an√°lise comportamental e de performance dos Analistas T√©cnicos (ATs) respons√°veis pela fase de An√°lise DO.

```bash
# Executar an√°lise de analistas (quando dispon√≠vel)
python analise_analistas.py
```

**An√°lises planejadas:**
- Performance individual por analista
- Padr√µes de especializa√ß√£o por √°rea tecnol√≥gica
- Consist√™ncia temporal nas decis√µes
- Distribui√ß√£o de carga de trabalho
- Identifica√ß√£o de vieses individuais

## üîç Contexto e Objetivos da An√°lise

O projeto analisa o fluxo completo dos projetos da Lei do Bem, que passam pelas seguintes fases:

1. **Preenchimento:** Dados iniciais da empresa e projeto
2. **An√°lise DO:** Avalia√ß√£o t√©cnica pelos Analistas T√©cnicos
3. **Parecer:** Consolida√ß√£o e decis√£o final
4. **Contesta√ß√£o:** Recurso da empresa (quando aplic√°vel)

### Principais Objetivos:

- **Consist√™ncia entre fases:** Identificar diverg√™ncias entre DO e Parecer
- **Padr√µes de contesta√ß√£o:** Caracter√≠sticas dos projetos que geram recursos
- **Detec√ß√£o de vieses:** Inconsist√™ncias por √°rea, porte ou analista
- **Otimiza√ß√£o do processo:** Propor melhorias baseadas em dados

## ü§ñ Detalhes T√©cnicos

### Processamento de Texto e NLP
- **Extra√ß√£o sem√¢ntica:** Foco em descri√ß√£o, metodologia, desafio tecnol√≥gico
- **Embeddings:** Modelo SERAFIM otimizado para portugu√™s t√©cnico
- **Stop words:** Customizadas para dom√≠nio P&D e Lei do Bem

### Machine Learning e Estat√≠stica
- **Clustering:** K-Means com otimiza√ß√£o autom√°tica via Silhouette Score
- **Classifica√ß√£o:** Random Forest com balanceamento de classes
- **Interpretabilidade:** SHAP values para explicar decis√µes
- **Valida√ß√£o:** Cross-validation estratificada

### An√°lise de Dados
- **An√°lise multivariada:** Correla√ß√µes entre m√∫ltiplas dimens√µes
- **Detec√ß√£o de anomalias:** Casos extremos e inconsist√™ncias
- **Visualiza√ß√£o:** Matplotlib, Seaborn, plots interativos

## üìÅ Arquivos de Sa√≠da

### Etapa 1 - Extra√ß√£o
- **Aglomerados:** `tabelas_csv_xlsx/projetos_lei_do_bem_2023_AGLOMERADOS.csv`
- **Detalhados:** `csv_longo/projetos_lei_do_bem_2023_DETALHADO_LINHA_UNICA.csv`

### Etapa 2 - Clusteriza√ß√£o
- **Clusters:** `Analises/lei_bem_projetos_clusters.csv`
- **Relat√≥rio PDF:** `Analises/relatorio_clusters_lei_bem.pdf`
- **An√°lise de clusters:** `Analises/lei_bem_analise_clusters.csv`

### Etapa 3 - An√°lise Multivariada
- **Insights:** `insights_padroes_decisao_YYYYMMDD_HHMMSS.txt`
- **Predi√ß√µes:** `projetos_com_predicoes.csv`
- **Import√¢ncia:** `feature_importance.csv`
- **Modelo:** `modelo_rf_padroes_decisao.pkl`

## üìä Exemplo de Uso Completo

```bash
# Pipeline completo
source .venv/bin/activate

# 1. Extrair dados do banco
python 1.csv_gerador_projetos.py

# 2. Aplicar clusteriza√ß√£o e an√°lise de padr√µes
python 2.report_e_clustering_k_mean.py

# 3. Executar an√°lise multivariada
python analise_multivariada_lei_bem.py

# 4. An√°lise espec√≠fica de analistas (futuro)
# python analise_analistas.py

# Verificar resultados
ls -la Analises/
ls -la imagens_relatorio/
```

## üÜò Troubleshooting

### Erro de Conex√£o com Banco (Etapa 1)
```
psycopg2.OperationalError: could not connect to server
```
**Solu√ß√£o:** Verifique se PostgreSQL est√° ativo e credenciais est√£o corretas.

### Erro de Arquivo N√£o Encontrado (Etapa 2)
```
FileNotFoundError: Nenhum arquivo CSV encontrado na pasta csv_longo
```
**Solu√ß√£o:** Execute primeiro a Etapa 1 (`1.csv_gerador_projetos.py`).

### Erro de Depend√™ncias SHAP (Etapa 3)
```
ImportError: No module named 'shap'
```
**Solu√ß√£o:** 
```bash
source .venv/bin/activate
uv add shap
```

### Problemas com Encoding
```
UnicodeDecodeError: 'utf-8' codec can't decode
```
**Solu√ß√£o:** Verifique se os arquivos CSV est√£o salvos com encoding UTF-8.

## üîÑ Desenvolvimento e Customiza√ß√£o

### Ajustar Par√¢metros de Clustering
Edite [`2.report_e_clustering_k_mean.py`](2.report_e_clustering_k_mean.py):
```python
# Para mais clusters (K menor)
analisador.analisar_kmeans_otimizado(max_k=50)

# Para menos clusters (K maior)  
analisador.analisar_kmeans_otimizado(max_k=20)
```

### Modificar Features da An√°lise Multivariada
Edite [`analise_multivariada_lei_bem.py`](analise_multivariada_lei_bem.py):
```python
# Adicionar novas features categ√≥ricas
features_categoricas.extend([
    'nova_coluna_categorica',
    'outra_feature'
])
```

### Integra√ß√£o com LLMs
Use o template em [`prompt.md`](prompt.md) para an√°lises com LLMs:
```python
# Carregar template
with open('prompt.md', 'r', encoding='utf-8') as f:
    prompt_template = f.read()

# Integrar dados
dados_formatados = prompt_template.format(df.head(100).to_csv())
```

## üìà M√©tricas de Performance

- **Cobertura de dados:** 100% dos projetos da base s√£o analisados
- **Escalabilidade:** Testado com datasets de 50k+ projetos
- **Acur√°cia do modelo:** ROC-AUC > 0.85 para predi√ß√£o de aprova√ß√£o
- **Velocidade:** Processamento otimizado com paraleliza√ß√£o

## üéØ Roadmap e Pr√≥ximos Passos

### Em Desenvolvimento
- [ ] **An√°lise de Analistas:** M√≥dulo espec√≠fico para ATs ([`analise_analistas.py`](analise_analistas.py))
- [ ] **Dashboard Interativo:** Plotly/Dash para visualiza√ß√£o em tempo real
- [ ] **API REST:** Endpoint para an√°lise de novos projetos

### Futuras Implementa√ß√µes
- [ ] **An√°lise Temporal:** Evolu√ß√£o dos padr√µes ao longo do tempo
- [ ] **NLP Avan√ßado:** An√°lise de sentimento nas justificativas
- [ ] **Detec√ß√£o de Fraude:** Identifica√ß√£o de padr√µes suspeitos
- [ ] **Sistema de Recomenda√ß√£o:** Sugest√µes para melhoria dos projetos

### Integra√ß√µes Planejadas
- [ ] **LangChain + LLMs:** An√°lise autom√°tica de justificativas
- [ ] **MLflow:** Versionamento e deploy de modelos
- [ ] **Apache Airflow:** Automatiza√ß√£o do pipeline

## üìñ Contexto da Lei do Bem

A Lei do Bem (Lei n¬∫ 11.196/2005) oferece incentivos fiscais para empresas que investem em P&D. O projeto analisa dados do MCTI para:

- **Otimizar** o processo de avalia√ß√£o
- **Identificar** padr√µes de aprova√ß√£o/reprova√ß√£o
- **Detectar** inconsist√™ncias e vieses
- **Propor** melhorias baseadas em evid√™ncias

## ü§ù Contribui√ß√µes

Contribui√ß√µes s√£o bem-vindas! Por favor:

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/AmazingFeature`)
3. Commit suas mudan√ßas (`git commit -m 'Add some AmazingFeature'`)
4. Push para a branch (`git push origin feature/AmazingFeature`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° sob licen√ßa MIT. Veja o arquivo `LICENSE` para mais detalhes.

## üìû Contato

Para d√∫vidas ou sugest√µes sobre a an√°lise dos dados da Lei do Bem, entre em contato
